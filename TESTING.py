# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡠⠔⠊⠉⣉⡉⢩⠃⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡠⠔⠊⠁⢀⡤⢄⣜⣀⣠⠃⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡠⠄⠊⠁⠀⠀⠀⢀⠞⠀⠀⠀⠀⣹⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠄⠊⠁⠀⠀⠀⠀⠀⠀⢠⠋⠀⠀⠂⠀⠀⡏⠀⠀⢀⡠⢄⣀⣀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠰⠆⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠇⠀⠆⠀⡀⠁⢸⠁⡀⠎⠁⠀⠀⠀⠀⠈⡹
# ⠀⠀⠀⠀⠀⠀⣀⠔⠈⠀⠀⠀⠀⢉⣵⡶⠒⠠⠤⠴⠭⠥⣭⢽⣉⣉⣉⡉⠐⠒⠒⠂⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠋⠀⡀⠄⠀⡀⠀⡿⠉⠀⠀⠀⠀⠀⠀⠀⡐⠁
# ⣀⡤⠐⠊⣿⠭⣀⠀⠀⠀⢀⣀⣤⣷⠏⠀⠀⠀⠀⠀⢠⠚⣠⣬⡟⠭⢭⡽⢛⠟⠙⠒⠒⠂⠦⠤⢤⣀⣀⣀⠀⠀⠀⠀⠀⠰⢷⣶⣴⣤⣤⣤⣀⣀⡇⠀⠀⠀⠀⠀⠀⠀⡰⠁⠀
# ⠉⠢⣔⠠⠈⠙⠲⢵⣮⠽⠟⠚⢉⡩⠤⠔⠒⠒⠒⠐⠺⠤⠤⠤⣀⣉⣉⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠙⠒⠒⠲⢤⣀⣌⠉⠛⠲⢿⣛⡟⡶⣤⣀⠀⠀⠀⡘⠁⠀⠀
# ⠀⠀⠀⠉⠒⠦⠄⣀⡀⢀⡠⠊⠁⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠁⠒⠒⠤⠤⢀⣀⠀⠀⣀⣀⣀⣀⣀⠀⠀⢠⣿⡿⠋⣹⣶⣤⡀⠀⢉⣑⠷⠮⠽⠶⡔⠁⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⢁⠲⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⢹⠃⠉⠉⠉⠙⣧⠀⣿⡟⠀⢰⡿⡇⠰⣿⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠓⠒⠤⠤⢄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡏⠀⠄⢀⠀⡀⠘⣟⠛⠧⢄⡘⣿⠁⢂⡝⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠳⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠶⣶⣤⣤⣤⣤⡼⣦⡀⠀⠈⠙⠛⠥⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠔⠒⢂⣤⠏⠙⠻⢝⣯⢝⡳⢦⡀⠀⠀⢀⡤⠚⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠎⠀⢀⡶⠉⢸⠀⠀⠀⠀⠈⠹⢾⣁⠿⣆⠎⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡏⠀⠀⠀⠀⠀⠀⠀⠀⢀⠤⠊⢀⡠⠚⠁⠀⠀⡆⠀⠀⠀⠀⠀⠀⣀⠜⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⢀⡠⠚⠁⡠⠒⠁⠀⠀⠀⠀⠀⠁⠒⠒⠠⠤⠔⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠁⠀⠀⠀⣠⠔⠁⡠⠔⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⢀⣀⡠⣝⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
# F-35 SUPREMACY

import torch
import torchvision
from torchvision import datasets, transforms
from torchvision.models import resnet18
from torch.utils.data import DataLoader
import torch.nn as nn
import torch.optim as optim
import tensorflow as tf
from TENSORFLOW_model_training import getcoefs
import cv2
import numpy as np

src_width, src_height = 5120, 2880
dest_width, dest_height = 1720, 720

# LOAD DATASET AND MODEL
DATASET = "datasetV3"
MODEL = "datasetV3_TENSORFLOW"
model = cv2.dnn.readNetFromONNX(f"ONNX_models/{MODEL}.onnx")
cursor = cv2.imread("assets/MISSILE_CURSOR.png", cv2.IMREAD_UNCHANGED)


def hex_to_rgb(hex_color):
    return tuple(int(hex_color[i:i + 2], 16) for i in (0, 2, 4))


def resize_coordinates(base_width, base_height, src_width, src_height, dest_width, dest_height):
    ratio_width = dest_width / src_width
    ratio_height = dest_height / src_height
    new_width = int(base_width * ratio_width)
    new_height = int(base_height * ratio_height)
    return new_width, new_height


def add_cursor_to_image(image, cursor):
    cursor_height, cursor_width = cursor.shape[:2]
    image_height, image_width = image.shape[:2]
    center_y = image_height // 2 - cursor_height // 2
    center_x = image_width // 2 - cursor_width // 2
    alpha_mask = cursor[:, :, 3] / 255.0
    alpha_inverse = 1.0 - alpha_mask
    for c in range(0, 3):
        image[center_y:center_y + cursor_height, center_x:center_x + cursor_width, c] = (
                alpha_mask * cursor[:, :, c] +
                alpha_inverse * image[center_y:center_y + cursor_height, center_x:center_x + cursor_width, c]
        )
    return image


def preview(path):
    dest_width, dest_height = 1720, 720
    # LOAD IMAGE
    IMAGE_PATH = path
    image = cv2.imread(IMAGE_PATH)
    image = cv2.resize(image, (dest_width, dest_height))

    # DETECT VEHICLES
    blob = cv2.dnn.blobFromImage(image, 1 / 255, (224, 224), (0, 0, 0), swapRB=True, crop=False)
    model.setInput(blob)
    output = model.forward()
    _, predicted = torch.max(torch.tensor(output), 1)

    #PREVIEW THE IMAGE
    cv2.imshow("Image", image)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
    imgpreview = image.copy()
    ORIGIN_x1, ORIGIN_y1, ORIGIN_x2, ORIGIN_y2, predicted = getcoefs(path)
    x1, y1 = resize_coordinates(ORIGIN_x1, ORIGIN_y1, src_width, src_height, dest_width, dest_height)
    x2, y2 = resize_coordinates(ORIGIN_x2, ORIGIN_y2, src_width, src_height, dest_width, dest_height)
    cv2.rectangle(imgpreview, (x1, y1), (x2, y2), (0, 0, 255), 2)

    # PREVIEW THE IMAGE
    cv2.imshow("Image", imgpreview)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
    ORIGIN_x1, ORIGIN_y1, ORIGIN_x2, ORIGIN_y2, predicted = getcoefs(IMAGE_PATH)
    print(f"Detected class: {predicted}")

    x1, y1 = resize_coordinates(ORIGIN_x1, ORIGIN_y1, src_width, src_height, dest_width, dest_height)
    x2, y2 = resize_coordinates(ORIGIN_x2, ORIGIN_y2, src_width, src_height, dest_width, dest_height)
    centertank = ((x1 + x2) // 2, (y1 + y2) // 2)

    image_height, image_width = image.shape[:2]
    cursor_height, cursor_width = cursor.shape[:2]
    zoom_factor = 1.0
    max_zoom = 3

    while zoom_factor < max_zoom:
        crop_height = int(image_height / zoom_factor)
        crop_width = int(image_width / zoom_factor)
        start_y = max(0, centertank[1] - crop_height // 2)
        start_x = max(0, centertank[0] - crop_width // 2)
        end_y = min(image_height, start_y + crop_height)
        end_x = min(image_width, start_x + crop_width)
        cropped_image = image[start_y:end_y, start_x:end_x]
        zoomed_image = cv2.resize(cropped_image, (image_width, image_height), interpolation=cv2.INTER_LINEAR)
        displayed_image = add_cursor_to_image(zoomed_image.copy(), cursor)

        adj_x1 = max(0, x1 - start_x)
        adj_y1 = max(0, y1 - start_y)
        adj_x2 = min(crop_width, x2 - start_x)
        adj_y2 = min(crop_height, y2 - start_y)

        dest_height, dest_width = crop_height, crop_width
        x1, y1 = resize_coordinates(ORIGIN_x1, ORIGIN_y1, src_width, src_height, dest_width, dest_height)

        if predicted == 2:
            cv2.rectangle(displayed_image, (x1, y1), (x2, y2), (0, 0, 255), 2)
            cv2.putText(displayed_image, "Tank", (x1, y1 - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.9, (0, 0, 255), 2)
        elif predicted == 1:
            cv2.rectangle(displayed_image, (x1, y1), (x2, y2), (222, 12, 255), 2)
            cv2.putText(displayed_image, "SPAA", (x1, y1 - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.9, (222, 12, 255), 2)
        else:
            cv2.rectangle(displayed_image, (x1, y1), (x2, y2), (15, 172, 255), 2)
            cv2.putText(displayed_image, "Military vehicle", (x1, y1 - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.9,
                        (15, 172, 255), 2)

        cv2.imshow("Zooming Image", displayed_image)
        key = cv2.waitKey(2) & 0xFF
        if key == 27:
            break
        zoom_factor += 0.005

    displayed_image = add_cursor_to_image(zoomed_image.copy(), cursor)
    cv2.imshow("Final Image", displayed_image)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
    exit(0)


if __name__ == "__main__":
    preview()
    exit(0)
